# 应用层

  不同的网络应用之间需要有一个确定的通信规则。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702215803534.png?raw=true)

## 两种常用的网络应用模型

### 客户/服务器模型（`Client/Server`）

### ![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702220439646.png?raw=true)

### `P2P`模型

**网络健壮性**指的是`P2P`模型**不容易坏掉**，即使一个节点坏了也没问题，可以有其他节点代替。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702220544850.png?raw=true)

## 域名解析系统`DNS`

`DNS`系统就是将打在**地址栏的域名**转化为`IP`地址的系统。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702220920296.png?raw=true)

### 域名

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702221601437.png?raw=true)

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702221626114.png?raw=true)

### 域名服务器（`DNS`服务器）

`DNS`服务器有很多台，根据层次结构分为**三层**：**根域名服务器，顶级域名服务器，权限域名服务器**。

**根域名服务器**并不是一个域名只有一台，而是**一个域名对应多台域名服务器**，全世界一共有`13`个这样的域名，分别是`a.rootservers.net`，`b.rootservers.net`，`c.rootservers.net`，`----`，`m.rootservers.net`。根域名服务器**掌握了所有顶级域名服务器的`IP`地址**。

在**权限域名服务器**中，虽然看似`abc.com`比`y.abc.com`少了一位，但是他们的**地位仍是对等**的，**对应的两台权限域名服务器**。

**本地域名服务器**不算层次结构，特点是**离主机比较近**，当主机和另一台**比较近的主机通信**时，就不用走那些**更高级**的服务器。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702222254726.png?raw=true)

### 域名解析过程

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702223128655.png?raw=true)

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702223220720.png?raw=true)

#### 迭代查询

主机先是向**本地域名服务器**发送请求，如果查不到的话，本地域名服务器向根域名服务器发送请求（找别人），如果还是查不到的话，根域名域名服务器向顶级域名服务器发送请求（找别人），如果还是查不到的话，顶级域名服务器向权限域名服务器发送请求（找别人）。可以看到每一次向下一个查询的服务器都变了，不是主机一个个去问，而是服务器自己一个个问下去。

#### 递归查询

主机先是向**本地域名服务器**发送请求，如果查不到的话，本地域名服务器就让主机去向根域名服务器发送请求（主机去找，本地域名给目标根域名服务器的IP地址），如果还是查不到的话，根域名域名服务器让主机去向对应的顶级域名服务器发送请求（主机去找，根域名给目标顶级域名服务器的`IP`地址），如果还是查不到的话，顶级域名服务器让主机去向权限域名服务器发送请求（主机去找，顶级域名给目标权限域名服务器的`IP`地址）。可以看到这里是主机一个个挨个问的地址。

#### 高速缓存

为了减少**多次查询同一个域名的资源浪费**，本地域名服务器会存储最近使用的`ip`地址解析，下次再访问同一个域名就不需要这么多查询步骤了。同时这个高速缓存主机本身也有存储，**本地域名服务器还可以对顶级域名服务器，权限域名服务器的地址进行缓存**，下一次即使是不知道的`ip`地址，查询也可以更快。高速缓存为了保持正确性，需要**定时更新**。

## 文件传送协议

### `TFTP`协议

`TFTP`是一个**轻量的**，比较**容易实现的**，面对**小文件**的，`UDP`的文件传输协议。

### `FTP`协议

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702224616787.png?raw=true)

#### `FTP`的服务端和客户端

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702224816512.png?raw=true)

#### `FTP`的工作原理

为什么有**匿名登陆**：对于一些公共服务器来说，**增加验证阶段**就是**增加资源开销**，**减少验证阶段**就可以**节省资源来更好地服务**。

主进程和从属进程的区别：主进程是**打开端口**，让外部发送的数据**可以进来**，并且将这些数据逐个**分配各从属进程**。从属进程则是**单独为这些数据服务**。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200702225039138.png?raw=true)

注释：这里的主进程被忽略掉了，只是没标在上面，并不是没有。
这里客户端和服务器端**先建立`TCP`连接**，**端口是`21`**，称为**控制连接**，然后看情况是**主动建立连接**还是**被动建立连接**。
**主动建立连接**是指服务器端**主动发送请求和客户端进行连接**，此时端口号固定是`20`。
**被动连接**是指**客户端发送请求和服务器端建立数据传送连接**，此时端口号是**不确定**，由两者协商得到。
数据传输完成之后，**数据连接断开**，**控制连接继续保持**，直至两边发送**断开请求**。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703000333330.png?raw=true)

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703000905460.png?raw=true)

## 电子邮件

### 电子邮件的格式

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703001117831.png?raw=true)

### 电子邮件系统的组成结构

用户代理的四个功能解释：

1. 撰写就是给用户编辑信件的环境。
2. 显示就是可以看到自己写的和自己收的信件内容。
3. 处理就是对信件进行操作，包括删除，打印，转发等等。
4. 通信就是可以将邮件发送到邮件服务器当中，同时可以从邮件服务器当中读取邮件。

邮件服务器的功能注释：

- 邮件服务器端的发送和接受是指从自己的用户代理处接收邮件，之后向对面的邮件服务器发送邮件。
- 邮件服务器的报告邮件发送结果就是投递是否成功这种情况。
- 邮件服务器既可以作为客户端又可以作为服务器端，使用的是`C/S`方式。

协议的功能注释：
发邮件用的是`SMTP`
收邮件的是`POP3`或者`IMAP`

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703001436566.png?raw=true)

### 简单邮件传送协议`SMTP`

注意一下，这里`SMTP`客户和服务器不是固定死的，用户可以成为服务器，服务器也可以成为用户，由发送方和接收方决定，**发送方就是客户，接收方就是服务器**。`SMTP`协议建立在`TCP`协议之上。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703002319315.png?raw=true)

#### 协议实例

这里`RCPT`能有**多条命令**的原因是，电子邮件可以有**多个收件人**，就是群发，所以允许多个`RCPT`。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703002844133.png?raw=true)

###   改进`SMTP`缺点的`MIME`协议（`Multipurpose Internet Mail Extensions`）

`MIME`改善`SMTP`发送数据的缺点，是`SMTP`的功能性扩展，`MIME`协议已经逐渐开始应用到浏览器当中，通过对不同文件类型用**不同的标识符标识**，来让浏览器读取通过`MIME`的相关文件。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703003639358.png?raw=true)

### `POP3`协议

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703003942969.png?raw=true)

### 比较复杂的读取邮件的协议——`IMAP`协议

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703004334235.png?raw=true)

### 基于万维网的电子邮件

与之前的不同的地方就是，基于万维网的电子邮件的**邮件服务器端可以不同**。同时，发送邮件使用的`SMTP/MIME`和收邮件时的`POP3/IMAP`协议都**换成了HTTP协议**。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/2020070300482031.png?raw=true)

##  万维网和`HTTP`协议

`URL`用来标识整个互联网当中的**某一个资源**（文字，视屏，音频等）的位置。

`HTTP`用来将这些资源**传送给用户**。

`HTML`帮助设计者来设计页面，让不同设计者设计的页面都可以在**界面上显示**。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703005114701.png?raw=true)

### `HTTP`协议

#### `HTTP`协议的过程

服务器通过`TCP 80`端口来监听`HTTP`请求，注意`HTTP`可以不一次性下载完页面的所有资源，可以只下载**文本部分**，其他音频视频等待用户**下一步请求之后再传输**。

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703005650472.png?raw=true)

#### `HTTP`协议的特点

![在这里插入图片描述](https://github.com/NoAlligator/pico/blob/main/img/20200703010043691.png?raw=true)

#### `HTTP`的连接方式——持久连接和非持久连接

**非持久连接**在`TCP`三次握手的**第三次握手**时发生，将`HTTP`请求作为**第三次握手**的数据部分发给服务器，服务器收到请求之后将`HTTP`相应报文传输给客户。耗时就是`RTT*2+文档传输时间`。
缺点：如果再想传输，那么就需要**重新建立`TCP`连接从头开始**。

**持久连接**和非持久连接类似，都是在**第三次握手**时发生，将`HTTP`请求作为**第三次握手**的数据部分发给服务器，服务器收到请求之后将`HTTP`相应报文传输给客户。但是持久连接再需要请资源的时候就不需要建立新的`TCP`连接了。

##### 持久连接的两种方式——非流水线和流水线

非流水线就是发一个，确认一个，才能再发下一个。
流水线就是一个个连着发，然后多个确认。

#### `HTTP`报文结构

开始行用于区别**请求报文**和**响应报文**。

- 请求报文的**方法**是指命令，就是对所请求的对象进行什么操作，如**获取/删除**等等。
- **`URL`**就是之间说的资源标识符。
- **版本**是指使用的是什么版本的`HTTP`协议。
- **`CRLF`**标识一行的结束，在整个首部行结束时，为了区别**首部行和实体主体**还会有一行单独的`CRLF`

![在这里插入图片描述](https://imgconvert.csdnimg.cn/aHR0cDovL2ltYWdlLmJpdGhhY2hpLmNuLyVFOCVBRSVBMSVFNyVBRSU5NyVFNiU5QyVCQSVFNyVCRCU5MSVFNyVCQiU5Qy5wbmc?x-oss-process=image/format,png)
